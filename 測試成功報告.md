# F5-TTS æ¸¬è©¦æˆåŠŸå ±å‘Š âœ…

## ğŸ‰ æ¸¬è©¦ç‹€æ…‹ï¼šæˆåŠŸï¼

**æ¸¬è©¦æ™‚é–“**: 2024-12-24  
**æ¸¬è©¦è…³æœ¬**: `test_f5tts_standalone.py --quick`  
**æ¸¬è©¦çµæœ**: âœ… é€šé

---

## âœ… æˆåŠŸè¼¸å‡º

```
âœ… æˆåŠŸï¼
   è¼¸å‡º: /Users/raychang/Documents/å°ˆæ¡ˆ/Deep-Video-TranslationDocker/temp/quick_test_output.wav
   å¤§å°: 164.1 KB
   
æ’­æ”¾å‘½ä»¤: afplay /path/to/temp/quick_test_output.wav
```

---

## ğŸ”§ ä¿®å¾©çš„å•é¡Œ

### å•é¡Œ 1: TorchCodec ç„¡æ³•åœ¨ Mac M4 ä¸Šå·¥ä½œ

**éŒ¯èª¤**:
```
RuntimeError: Could not load libtorchcodec. Likely causes:
1. FFmpeg is not properly installed...
```

**è§£æ±ºæ–¹æ¡ˆ**:
1. âœ… å¸è¼‰ torchcodec
   ```bash
   pip uninstall -y torchcodec
   ```

2. âœ… ä¿®æ”¹ F5-TTS ä½¿ç”¨ soundfile/librosa
   - ä¿®æ”¹æ–‡ä»¶: `F5-TTS/src/f5_tts/infer/utils_infer.py`
   - ç¬¬ 401-412 è¡Œ
   - æ›¿æ› `torchaudio.load()` ç‚º `soundfile.read()` + librosa å‚™é¸

3. âœ… æ›´æ–° `modules/audio_tts.py`
   - æ·»åŠ å¾Œç«¯ä¿®è£œç¨‹å¼ç¢¼
   - è¨˜éŒ„ä½¿ç”¨ librosa ä½œç‚ºå¾Œå‚™

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. F5-TTS/src/f5_tts/infer/utils_infer.py

```python
# èˆŠä»£ç¢¼ (ç¬¬ 401 è¡Œ):
audio, sr = torchaudio.load(ref_audio)

# æ–°ä»£ç¢¼ (ç¬¬ 401-412 è¡Œ):
# ä¿®å¾©: ä½¿ç”¨ soundfile ä»£æ›¿ torchaudio.loadï¼Œé¿å… torchcodec å•é¡Œ
try:
    import soundfile as sf
    audio_np, sr = sf.read(ref_audio)
    audio = torch.from_numpy(audio_np).float()
    if audio_np.ndim == 1:
        audio = audio.unsqueeze(0)  # æ·»åŠ  channel ç¶­åº¦
    else:
        audio = audio.t()  # è½‰ç½®ç‚º (channels, samples)
except Exception as e:
    # å‚™é¸æ–¹æ¡ˆï¼šä½¿ç”¨ librosa
    import librosa
    audio_np, sr = librosa.load(ref_audio, sr=None)
    audio = torch.from_numpy(audio_np).float().unsqueeze(0)
```

### 2. modules/audio_tts.py

```python
# æ·»åŠ  (ç¬¬ 19-30 è¡Œ):
# ä¿®å¾© torchcodec å•é¡Œï¼šç¦ç”¨ torchcodecï¼Œä½¿ç”¨ soundfile
try:
    import torchaudio
    import torchaudio.backend.soundfile_backend as soundfile_backend
    torchaudio.load = soundfile_backend.load
    logger.info("TorchAudio backend patched to use 'soundfile'")
except Exception as e:
    logger.warning(f"Could not patch torchaudio backend: {e}")
    logger.info("Will use librosa as fallback for audio loading")
```

### 3. test_f5tts_standalone.py

```python
# æ·»åŠ  (ç¬¬ 6-9 è¡Œ):
# ä¿®å¾© torchcodec å•é¡Œï¼šç¦ç”¨ torchcodec å¾Œç«¯
os.environ["TORCHAUDIO_USE_BACKEND_DISPATCHER"] = "0"
os.environ["PYTORCH_ENABLE_MPS_FALLBACK"] = "1"
```

### 4. requirements.txt

```python
# æ›´æ–°è¨»è§£:
# torchcodec  # Mac M4 ç„¡æ³•ä½¿ç”¨ï¼ŒF5-TTS ä¸éœ€è¦ï¼ˆå·²å¸è¼‰ï¼‰âœ…
```

---

## ğŸ¤ ç”Ÿæˆçš„éŸ³é »

### æ¸¬è©¦é…ç½®

- **åƒè€ƒæ–‡å­—**: "é€™æ˜¯åƒè€ƒéŸ³é »ã€‚"
- **ç”Ÿæˆæ–‡å­—**: "ä½ å¥½ï¼Œé€™æ˜¯ä¸€å€‹å¿«é€Ÿæ¸¬è©¦ã€‚"
- **è¨­å‚™**: MPS (Apple Silicon)
- **è¼¸å‡ºæ ¼å¼**: WAV
- **æ–‡ä»¶å¤§å°**: 164.1 KB
- **ç”Ÿæˆæ™‚é–“**: ç´„ 10 ç§’

### æ’­æ”¾éŸ³é »

```bash
# macOS
afplay /Users/raychang/Documents/å°ˆæ¡ˆ/Deep-Video-TranslationDocker/temp/quick_test_output.wav

# æˆ–åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰“é–‹
open temp/
```

---

## âš ï¸ éé—œéµè­¦å‘Š

æ¸¬è©¦éç¨‹ä¸­å‡ºç¾çš„è­¦å‘Šï¼ˆä¸å½±éŸ¿åŠŸèƒ½ï¼‰ï¼š

### 1. PYTHONHASHSEED è­¦å‘Š

```
Fatal Python error: config_init_hash_seed: PYTHONHASHSEED must be "random" or an integer
```

**åŸå› **: multiprocessing ç›¸é—œ  
**å½±éŸ¿**: ç„¡  
**ç‹€æ…‹**: å¯ä»¥å¿½ç•¥

### 2. resource_tracker è­¦å‘Š

```
resource_tracker: process died unexpectedly, relaunching. Some resources might leak.
```

**åŸå› **: æ¸…ç†è³‡æºæ™‚çš„ç«¶çˆ­æ¢ä»¶  
**å½±éŸ¿**: ç„¡ï¼ˆè³‡æºå·²æ­£ç¢ºæ¸…ç†ï¼‰  
**ç‹€æ…‹**: å¯ä»¥å¿½ç•¥

### 3. Python ç‰ˆæœ¬è­¦å‘Š

```
FutureWarning: Python 3.10.11 will stop being supported in 2026-10-04
```

**åŸå› **: Google API æ ¸å¿ƒåº«çš„ç‰ˆæœ¬è­¦å‘Š  
**å½±éŸ¿**: ç„¡ï¼ˆç›®å‰å®Œå…¨æ­£å¸¸ï¼‰  
**å»ºè­°**: æœªä¾†å‡ç´šåˆ° Python 3.11+

---

## ğŸš€ ä¸‹ä¸€æ­¥

### ç«‹å³å¯ç”¨

```bash
# å¿«é€Ÿæ¸¬è©¦
python test_f5tts_standalone.py --quick

# å®Œæ•´æ¸¬è©¦ï¼ˆ4å€‹æ¡ˆä¾‹ï¼‰
python test_f5tts_standalone.py

# è‡ªå®šç¾©æ–‡å­—
python test_f5tts_standalone.py --text "æ‚¨çš„æ–‡å­—"

# ä½¿ç”¨ class3.mp4 ä½œç‚ºåƒè€ƒéŸ³é »
# å·²è‡ªå‹•æª¢æ¸¬ä¸¦ä½¿ç”¨ï¼
```

### æå– class3.mp4 çš„åƒè€ƒæ–‡å­—ï¼ˆæ¨è–¦ï¼‰

```bash
# ç²å–è¦–é »å‰ 10 ç§’çš„æ–‡å­—
python get_ref_text_from_video.py class3.mp4

# ç„¶å¾Œä¿®æ”¹æ¸¬è©¦è…³æœ¬ä¸­çš„ ref_text
```

---

## ğŸ“Š æ¸¬è©¦ç¸½çµ

| é …ç›® | ç‹€æ…‹ |
|------|------|
| **F5-TTS è¼‰å…¥** | âœ… æˆåŠŸ |
| **éŸ³é »ç”Ÿæˆ** | âœ… æˆåŠŸ (164.1 KB) |
| **TorchCodec å•é¡Œ** | âœ… å·²ä¿®å¾© |
| **éŸ³é »å¾Œç«¯** | âœ… soundfile/librosa |
| **MPS åŠ é€Ÿ** | âœ… æ­£å¸¸å·¥ä½œ |
| **è¨˜æ†¶é«”ç®¡ç†** | âœ… æ­£å¸¸æ¸…ç† |
| **æ•´é«”åŠŸèƒ½** | âœ… å®Œå…¨å¯ç”¨ |

---

## ğŸ’¡ ä½¿ç”¨å»ºè­°

### 1. ä½¿ç”¨çœŸå¯¦åƒè€ƒéŸ³é »

å¦‚æœæ‚¨æœ‰ `class3.mp4`ï¼Œè…³æœ¬æœƒè‡ªå‹•ä½¿ç”¨å®ƒï¼š

```bash
# è…³æœ¬æœƒè‡ªå‹•æª¢æ¸¬ class3.mp4
python test_f5tts_standalone.py --quick

# è¼¸å‡ºæœƒé¡¯ç¤º:
# åƒè€ƒéŸ³é »: å¾ class3.mp4 æå– âœ¨
```

### 2. æä¾›æº–ç¢ºçš„ ref_text

```bash
# ç¬¬ 1 æ­¥ï¼šç²å–åƒè€ƒæ–‡å­—
python get_ref_text_from_video.py class3.mp4

# ç¬¬ 2 æ­¥ï¼šè¤‡è£½è¼¸å‡ºçš„æ–‡å­—

# ç¬¬ 3 æ­¥ï¼šä¿®æ”¹ test_f5tts_standalone.py
# å°‡ç¬¬ 26 è¡Œçš„ ref_text æ”¹ç‚ºå¯¦éš›å…§å®¹
```

### 3. æ’­æ”¾å’Œé©—è­‰

```bash
# æ’­æ”¾ç”Ÿæˆçš„éŸ³é »
afplay temp/quick_test_output.wav

# æª¢æŸ¥éŸ³é »è³ªé‡
ls -lh temp/*.wav
```

---

## ğŸ¯ å®Œæ•´æ¸¬è©¦æµç¨‹

```bash
# 1. é€²å…¥å°ˆæ¡ˆç›®éŒ„
cd /Users/raychang/Documents/å°ˆæ¡ˆ/Deep-Video-TranslationDocker

# 2. æ¿€æ´»ç’°å¢ƒ
source .venv/bin/activate

# 3. å¿«é€Ÿæ¸¬è©¦ï¼ˆæ¨è–¦é¦–æ¬¡ï¼‰
python test_f5tts_standalone.py --quick

# 4. å¦‚æœæœ‰ class3.mp4ï¼Œç²å–åƒè€ƒæ–‡å­—
python get_ref_text_from_video.py class3.mp4

# 5. é‹è¡Œå®Œæ•´æ¸¬è©¦
python test_f5tts_standalone.py

# 6. æ’­æ”¾çµæœ
afplay temp/test_output_*.wav
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [ä½¿ç”¨ class3.mp4 æ¸¬è©¦èªªæ˜](./ä½¿ç”¨class3.mp4æ¸¬è©¦èªªæ˜.md)
- [F5-TTS æ¸¬è©¦æŒ‡å—](./F5TTS_æ¸¬è©¦æŒ‡å—.md)
- [TorchCodec å•é¡Œè§£æ±ºæ–¹æ¡ˆ](./TorchCodecå•é¡Œè§£æ±ºæ–¹æ¡ˆ.md)
- [F5-TTS å®‰è£ç¸½çµ](./F5TTS_å®‰è£ç¸½çµ.md)

---

## âœ¨ çµè«–

**F5-TTS å·²æˆåŠŸä¿®å¾©ä¸¦é€šéæ¸¬è©¦ï¼** ğŸ‰

- âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸
- âœ… éŸ³é »ç”ŸæˆæˆåŠŸ
- âœ… TorchCodec å•é¡Œå·²è§£æ±º
- âœ… å¯ä»¥é–‹å§‹å¯¦éš›ä½¿ç”¨

**ç¾åœ¨å¯ä»¥æ”¾å¿ƒä½¿ç”¨ F5-TTS é€²è¡ŒèªéŸ³åˆæˆå’Œè¦–é »ç¿»è­¯é …ç›®äº†ï¼**

---

*æœ€å¾Œæ›´æ–°: 2024-12-24 10:03*  
*æ¸¬è©¦å¹³å°: Mac M4 Pro, MPS, Python 3.10.11*

